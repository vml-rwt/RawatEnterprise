sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/export/library","sap/ui/export/Spreadsheet"],(e,t,o,r,i)=>{"use strict";var s=r.EdmType;return e.extend("rwt.etp.invoicing.controller.CreateInvoice",{onInit:function(){this._oView=this.getView();this._ProductData=this.getOwnerComponent().getModel("ProductModel");this._ServerModel=this.getOwnerComponent().getModel();this._ProductData.setSizeLimit(1e3);this._ServerModel.setSizeLimit(1e3);this._ProdctsCtx=this._ServerModel.bindList("/Products");this._ProdctsCtx.requestContexts(0,1e3).then(function(e){let t=e.map(function(e){e.getObject().Selling_Price=parseInt(e.getObject().Selling_Price);e.getObject().Cost_Price=parseInt(e.getObject().Cost_Price);e.getObject().Available_Qty=parseInt(e.getObject().Available_Qty);return e.getObject()});this._ProductData.setData(t)}.bind(this)).catch(function(e){console.error("Error while fetching from server OData:",e)})},onSuggestionItemSelected:function(e){let t=e.getParameter("selectedItem");if(t){let o=t.getKey().split("--");let r=this._ProductData.getProperty("/");let i=r.find(e=>e.ProductCode===o[0]&&e.Packaging_Qty==o[1]);let s=this._oView.getModel("InvoiceModel");let n=s.getProperty("/");if(!Array.isArray(n)){n=[]}i.Sell_Qty=1;i.TotalPrice=i.Selling_Price;n.push(i);s.setProperty("/",n);s.updateBindings();e.getSource().setValue()}},updateSP:function(e){let t=e.getSource().getParent();let o=t.getBindingContextPath();let r=this.getView().getModel("InvoiceModel");let i=t.getAggregation("cells")[5].getValue();r.setProperty(`${o}/Selling_Price`,parseInt(i));let s=t.getAggregation("cells")[3].getValue();r.setProperty(`${o}/Sell_Qty`,s);let n=r.getProperty(`${o}/Selling_Price`);let l=r.setProperty(`${o}/TotalPrice`,parseInt(n)*s);r.refresh(true)},onTblUpdateFinsh:function(e){const t=this.byId("idTable");const o=t.getItems();let r=0;let i=0;o.forEach(e=>{const t=e.getBindingContext("InvoiceModel");if(t){const e=parseFloat(t.getProperty("TotalPrice"))||0;r+=e}});this.byId("idTotlVal").setText(r.toFixed(2))},onDelRow:function(e){const t=e.getSource();const o=t.getBindingContext("InvoiceModel");if(o){const e=o.getPath();const t=this.getView().getModel("InvoiceModel");const r=t.getProperty("/");const i=parseInt(e.split("/").pop());r.splice(i,1);t.setProperty("/",r);sap.m.MessageToast.show("Row deleted successfully")}},onResetPrs:function(){this.getView().getModel("InvoiceModel").setData().refresh(true)},onSaveInvoice:async function(){debugger;const e=this.getView().getModel("InvoiceModel").getProperty("/");const t=this._ServerModel;const o="invoiceStockUpdate";for(const r of e){const e=r.ProductCode;const i=r.Packaging_Qty;const s=`'${encodeURIComponent(e)}'`;const n=`/Products(ProductCode=${s},Packaging_Qty=${i})`;const l=t.bindContext(n,null,{$$updateGroupId:o});try{const e=r.Available_Qty-r.Sell_Qty;if(e<0){sap.m.MessageBox.error(`Not enough stock for ${r.Product}`);continue}const t=l.getBoundContext();t.setProperty("Available_Qty",e)}catch(e){console.error(`Error processing ${r.Product}:`,e);sap.m.MessageBox.error(`Error processing ${r.Product}: ${e.message}`)}}try{await t.submitBatch(o);sap.m.MessageToast.show("Invoice saved and stock updated!")}catch(e){console.error("Batch submission failed:",e);sap.m.MessageToast.show("Failed to update stock.")}},createColumnConfig:function(){var e=[];e.push({label:"Product",property:"Product",type:s.String,width:50});e.push({label:"Product Code",type:s.String,property:"ProductCode"});e.push({property:["Packaging_Qty","Unit"],label:"Packing",type:s.String,width:10,template:"{0} {1}"});e.push({label:"Cost Price",property:"Cost_Price",type:s.Number,width:15});e.push({label:"Selling Price (incl. GST)",property:"Selling_Price",type:s.Number,scale:2,width:15});e.push({label:"Quantity",property:"Sell_Qty",type:s.Number,scale:2,width:15});e.push({label:"Total",property:"TotalPrice",type:s.Number,scale:2,width:15});return e},onPrntPrs:function(){let e=this.byId("idCustmrNm").getValue();this.onSaveInvoice();if(!e){t.show("Enter Customer Name");return}const o=new Date;let r=this.byId("idTable");let s=r.getModel("InvoiceModel");let n=s.getProperty("/");const l=String(o.getDate()).padStart(2,"0");const c=String(o.getMonth()+1).padStart(2,"0");const a=String(o.getFullYear()).slice(-2);const d=`${l}${c}${a}`;e+="_"+d+"_"+this.byId("idTotlVal").getText();var g,p,u,h;p=r.getBinding("items");g=this.createColumnConfig();u={workbook:{context:{application:"Supplier Invoices List",version:"6.1.0-SNAPSHOT",title:"Supplier Invoices",modifiedBy:"Rawat Enterprises",sheetName:"Invoices"},columns:g,hierarchyLevel:"Level"},dataSource:p,fileName:e+".xlsx",worker:false};h=new i(u);h.build().finally(function(){h.destroy()})}})});
//# sourceMappingURL=CreateInvoice.controller.js.map